<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeMaster Pro - AI & Cloud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = {
            initializeApp, getAuth, GoogleAuthProvider, signInWithPopup, signInAnonymously, signOut, onAuthStateChanged,
            getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .chart-wrapper { position: relative; width: 100%; height: 300px; max-height: 300px; }
        .chart-wrapper-lg { position: relative; width: 100%; height: 400px; max-height: 400px; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }

        #login-screen { transition: opacity 0.5s ease-in-out; }
        .hidden-fade { opacity: 0; pointer-events: none; }
        
        .ai-response p { margin-bottom: 0.5rem; }
        .ai-response ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.5rem; }
        .ai-response strong { color: #4f46e5; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center text-white">
        <div class="text-center mb-8">
            <div class="h-16 w-16 bg-indigo-600 rounded-xl mx-auto flex items-center justify-center text-3xl font-bold shadow-lg mb-4">TM</div>
            <h1 class="text-3xl font-bold tracking-tight mb-2">TradeMaster Pro</h1>
            <p class="text-slate-400">Professional Trade Journaling & Analytics</p>
        </div>
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-slate-800 text-center">
            <h2 class="text-xl font-bold mb-6">Welcome Back</h2>
            <button id="google-login-btn" class="w-full border border-slate-300 bg-white hover:bg-slate-50 text-slate-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-3 transition-all shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                Sign in with Google
            </button>
            <p class="mt-6 text-xs text-slate-400">Login to sync your data across devices.<br>Guest access available for preview.</p>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <div class="fixed top-4 left-4 z-50 md:hidden">
        <button id="mobile-menu-btn" class="bg-white p-2 rounded shadow text-slate-600">‚ò∞</button>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col transition-transform transform -translate-x-full md:translate-x-0 fixed md:relative h-full z-40">
        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
            <h1 class="text-xl font-bold text-indigo-700 tracking-tight">TradeMaster Pro</h1>
            <button id="close-menu-btn" class="md:hidden text-slate-400">‚úï</button>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1 px-3">
                <li><button onclick="app.router('dashboard')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors" data-target="dashboard"><span>üìä</span> Dashboard</button></li>
                <li><button onclick="app.router('journal')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors" data-target="journal"><span>üìù</span> Trade Journal</button></li>
                <li><button onclick="app.router('calendar')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors" data-target="calendar"><span>üìÖ</span> P&L Calendar</button></li>
                <li><button onclick="app.router('analytics')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors" data-target="analytics"><span>üìà</span> Reports & Analytics</button></li>
                <li><button onclick="app.router('playbook')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-colors" data-target="playbook"><span>üìò</span> Strategy Playbook</button></li>
            </ul>
            <div class="mt-8 px-6">
                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Account</p>
                <div class="bg-slate-50 rounded-lg p-3 border border-slate-100 flex items-center gap-3 mb-2">
                    <img id="user-avatar" src="" class="w-8 h-8 rounded-full bg-slate-200 object-cover hidden">
                    <div class="overflow-hidden"><p id="user-name" class="text-sm font-bold text-slate-700 truncate">Guest</p><p class="text-xs text-slate-500 truncate">Balance: <span id="account-balance" class="text-emerald-600 font-mono font-bold">$24,500</span></p></div>
                </div>
                <!-- SETTINGS BUTTON -->
                <button onclick="app.openSettingsModal()" class="flex items-center gap-2 text-xs text-indigo-600 font-medium w-full text-left px-1 mb-2 hover:text-indigo-800">
                    ‚öôÔ∏è AI Settings (Setup Key)
                </button>
                <button id="logout-btn" class="text-xs text-red-500 hover:text-red-700 font-medium w-full text-left px-1">Sign Out</button>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-100 space-y-2">
            <button onclick="app.openAddTradeModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2.5 rounded-lg transition-colors shadow-sm flex items-center justify-center gap-2"><span>+</span> Log New Trade</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 flex-shrink-0">
            <h2 id="page-title" class="text-lg font-semibold text-slate-800">Overview</h2>
            <div class="flex items-center gap-4">
                <div class="relative">
                    <select id="global-filter-date" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2" onchange="app.updateGlobalFilter(this.value)">
                        <option value="all">All Time</option>
                        <option value="30">Last 30 Days</option>
                        <option value="7">Last 7 Days</option>
                    </select>
                </div>
                <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs border border-indigo-200">TM</div>
            </div>
        </header>

        <div id="content-viewport" class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-8 custom-scroll relative">
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-section space-y-6">
                <div class="flex justify-end">
                    <button onclick="app.generateWeeklyInsight()" class="bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-700 hover:to-indigo-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 transition-all"><span>‚ú®</span> Generate Weekly AI Insight</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><p class="text-xs font-semibold text-slate-500 uppercase">Net P&L</p><h4 id="kpi-pnl" class="text-2xl font-bold mt-1">$0.00</h4><p class="text-xs text-slate-400 mt-2">Total realized profit/loss</p></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><p class="text-xs font-semibold text-slate-500 uppercase">Win Rate</p><h4 id="kpi-winrate" class="text-2xl font-bold mt-1 text-slate-800">0%</h4><p class="text-xs text-slate-400 mt-2">Based on closed trades</p></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><p class="text-xs font-semibold text-slate-500 uppercase">Profit Factor</p><h4 id="kpi-pf" class="text-2xl font-bold mt-1 text-slate-800">0.00</h4><p class="text-xs text-slate-400 mt-2">Gross Profit / Gross Loss</p></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><p class="text-xs font-semibold text-slate-500 uppercase">Avg R-Multiple</p><h4 id="kpi-r" class="text-2xl font-bold mt-1 text-slate-800">0R</h4><p class="text-xs text-slate-400 mt-2">Risk to Reward Ratio</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col"><div class="flex items-center justify-between mb-4"><h3 class="font-semibold text-slate-700">Cumulative P&L (Equity Curve)</h3></div><div class="chart-wrapper-lg"><canvas id="chart-equity"></canvas></div></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col"><div class="flex items-center justify-between mb-4"><h3 class="font-semibold text-slate-700">Win / Loss Distribution</h3></div><div class="chart-wrapper flex items-center justify-center"><canvas id="chart-winloss"></canvas></div></div>
                </div>
            </div>

            <!-- JOURNAL -->
            <div id="view-journal" class="view-section hidden space-y-6">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center">
                    <div><h3 class="text-lg font-semibold text-slate-800 mb-1">Trade Log</h3><p class="text-slate-600 text-sm">Review individual entry and exit points.</p></div>
                    <button onclick="app.openAddTradeModal()" class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm font-semibold py-2 px-4 rounded transition-colors">+ New Entry</button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto custom-scroll">
                        <table class="w-full text-left text-sm text-slate-600"><thead class="bg-slate-50 text-xs uppercase font-semibold text-slate-500"><tr><th class="px-6 py-4">Date</th><th class="px-6 py-4">Symbol</th><th class="px-6 py-4">Side</th><th class="px-6 py-4">RR</th><th class="px-6 py-4 text-right">Risk %</th><th class="px-6 py-4 text-right">Entry</th><th class="px-6 py-4 text-right">Exit</th><th class="px-6 py-4 text-right">Net P&L</th><th class="px-6 py-4 text-center">Status</th></tr></thead><tbody id="journal-table-body" class="divide-y divide-slate-100"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- OTHER VIEWS (Calendar, Analytics, Playbook) -->
            <div id="view-calendar" class="view-section hidden space-y-6">
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex items-center justify-between mb-6"><h3 class="font-bold text-xl text-slate-800" id="calendar-month-label">Current Month</h3><div class="flex gap-2"><div class="flex items-center gap-2 text-xs text-slate-500 mr-4"><span class="w-3 h-3 rounded-sm bg-emerald-100 border border-emerald-300"></span> Profit<span class="w-3 h-3 rounded-sm bg-rose-100 border border-rose-300"></span> Loss</div></div></div>
                    <div class="calendar-grid text-center text-sm font-medium text-slate-400 mb-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                    <div id="calendar-grid" class="calendar-grid"></div>
                </div>
            </div>
            <div id="view-analytics" class="view-section hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-semibold text-slate-700 mb-4">Performance by Setup</h4><div class="chart-wrapper"><canvas id="chart-setup"></canvas></div></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-semibold text-slate-700 mb-4">P&L by Day of Week</h4><div class="chart-wrapper"><canvas id="chart-dow"></canvas></div></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-semibold text-slate-700 mb-4">Long vs Short Performance</h4><div class="chart-wrapper"><canvas id="chart-direction"></canvas></div></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-semibold text-slate-700 mb-4">P&L by Hour of Day</h4><div class="chart-wrapper"><canvas id="chart-hour"></canvas></div></div>
                </div>
            </div>
             <div id="view-playbook" class="view-section hidden space-y-6"><div id="playbook-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div></div>
        </div>

        <!-- SETTINGS MODAL (BYOK) -->
        <div id="settings-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg text-slate-800">AI Settings</h3>
                    <button onclick="app.closeSettingsModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="space-y-4">
                    <p class="text-sm text-slate-600 leading-relaxed">
                        <strong>Security Note:</strong> Google does not allow apps to automatically access your private API keys. You must generate one and paste it here.
                    </p>
                    <div class="p-3 bg-indigo-50 border border-indigo-100 rounded-lg">
                        <p class="text-xs text-indigo-700 mb-2 font-semibold">1. Get your free key from Google:</p>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="block w-full text-center bg-white border border-indigo-200 text-indigo-600 font-bold py-2 rounded text-xs hover:bg-indigo-50 transition-colors">
                            Open Google AI Studio ‚Üó
                        </a>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">2. Paste Key Here</label>
                        <input type="password" id="input-api-key" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="AIzaSy...">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="check-enable-ai" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                        <label for="check-enable-ai" class="text-sm font-medium text-slate-700">Enable AI Features</label>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="app.closeSettingsModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
                    <button onclick="app.saveSettings()" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded shadow-sm">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- ADD/EDIT TRADE MODAL -->
        <div id="add-trade-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-all scale-100 mx-4 custom-scroll" onclick="app.hideSymbolDropdown()">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 sticky top-0 z-10">
                    <h3 class="font-bold text-lg text-slate-800" id="modal-title">Log New Trade</h3>
                    <button onclick="app.closeAddTradeModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                <form id="add-trade-form" onsubmit="event.preventDefault(); app.saveTrade();" class="p-6 space-y-4">
                    <input type="hidden" id="edit-trade-id"> <!-- HIDDEN ID FOR EDITING -->
                    <!-- 1. CORE INFO -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative group">
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Symbol</label>
                            <input type="text" id="input-symbol" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none uppercase font-bold" placeholder="XAUUSD" required autocomplete="off" oninput="app.handleSymbolInput(this.value)" onclick="event.stopPropagation()">
                            <div id="symbol-dropdown" class="absolute z-50 w-full bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden custom-scroll"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Session</label>
                            <select id="input-session" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                <option value="Asia">Asia</option>
                                <option value="London">London</option>
                                <option value="NY">NY</option>
                            </select>
                        </div>
                        <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Date</label><input type="date" id="input-date" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" required></div>
                        <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Side</label><select id="input-side" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white"><option value="Long">Long</option><option value="Short">Short</option></select></div>
                    </div>

                    <!-- 2. CONFIRMATIONS & BIAS -->
                    <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                        <p class="text-xs font-bold text-indigo-800 uppercase tracking-wide mb-3">Strategy & Biases</p>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Biases -->
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Daily Bias</label><select id="input-conf-daily" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"><option value="Bullish">Bullish</option><option value="Bearish">Bearish</option><option value="Neutral">Neutral</option></select></div>
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">H11 Bias</label><select id="input-conf-h11" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"><option value="Bullish">Bullish</option><option value="Bearish">Bearish</option><option value="Neutral">Neutral</option></select></div>
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">H7 Bias</label><select id="input-conf-h7" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"><option value="Bullish">Bullish</option><option value="Bearish">Bearish</option><option value="Neutral">Neutral</option></select></div>
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">H3 Bias</label><select id="input-conf-h3" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"><option value="Bullish">Bullish</option><option value="Bearish">Bearish</option><option value="Neutral">Neutral</option></select></div>
                            <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">H1 Bias</label><select id="input-conf-h1" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"><option value="Bullish">Bullish</option><option value="Bearish">Bearish</option><option value="Neutral">Neutral</option></select></div>
                            
                            <!-- Setup -->
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Setup</label>
                                <select id="input-setup" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white font-medium text-slate-700">
                                    <option value="HCS">HCS</option><option value="IB Setup">IB Setup</option><option value="HCS Negation">HCS Negation</option><option value="Negation">Negation</option>
                                </select>
                            </div>

                            <!-- Additional Confs -->
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">TSL</label>
                                <select id="input-conf-tsl" class="w-full border border-slate-300 rounded p-2 text-sm bg-white">
                                    <option value="7 min">7 min</option><option value="10 min">10 min</option><option value="15 min">15 min</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Entry TF</label>
                                <select id="input-entry-tf" class="w-full border border-slate-300 rounded p-2 text-sm bg-white">
                                    <option value="1m">1m</option><option value="2m">2m</option><option value="3m">3m</option><option value="4m">4m</option><option value="5m">5m</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3. EXECUTION DETAILS -->
                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-100 grid grid-cols-2 gap-4">
                        <div class="col-span-2 flex justify-between items-end"><span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Execution</span><span id="rr-display" class="text-sm font-bold text-slate-600 bg-slate-200 px-2 py-0.5 rounded">R:R --</span></div>
                        <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Entry Price</label><input type="number" step="0.00001" id="input-entry" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0.00" required oninput="app.calculateRR()"></div>
                        <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Exit Price</label><input type="number" step="0.00001" id="input-exit" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0.00" required oninput="app.calculateRR()"></div>
                        <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Stop Loss (Pips)</label><input type="number" step="0.1" id="input-sl-pips" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="10" oninput="app.calculateRR()"></div>
                        <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Risk (%)</label><input type="number" step="0.1" id="input-risk-percent" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="1.0"></div>
                    </div>
                    <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Execution Notes</label><textarea id="input-notes" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-20 resize-none" placeholder="Execution thoughts..."></textarea></div>
                    <div><label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Screenshot URLs</label><textarea id="input-screenshot-urls" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-20 resize-none font-mono text-xs" placeholder="Paste image URLs here, one per line"></textarea></div>
                    <div class="pt-4 border-t border-slate-100 flex justify-end gap-3 mt-4">
                        <button type="button" onclick="app.closeAddTradeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
                        <button type="submit" class="px-4 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded shadow-sm">Save Trade</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TRADE DETAIL MODAL (UPDATED WITH EDIT BTN) -->
        <div id="trade-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden flex justify-end">
            <div class="w-full md:w-1/2 lg:w-1/3 bg-white h-full shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full" id="trade-modal-content">
                <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                    <div><h3 class="font-bold text-xl text-slate-800" id="modal-symbol">--</h3><p class="text-sm text-slate-500 font-medium" id="modal-session-date">--</p></div>
                    <div class="flex items-center gap-2">
                        <button onclick="app.editTrade(app.getCurrentTrade())" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-full transition-colors" title="Edit Trade">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                        <button onclick="app.closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                    </div>
                </div>
                <div class="p-6 flex-1 overflow-y-auto space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-100"><span class="text-xs text-slate-500 uppercase font-semibold">Net P&L</span><div class="text-xl font-bold mt-1" id="modal-pnl">--</div></div>
                        <div class="p-4 bg-slate-50 rounded-lg border border-slate-100"><span class="text-xs text-slate-500 uppercase font-semibold">Setup</span><div class="text-lg font-medium mt-1 text-slate-700" id="modal-setup">--</div></div>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4"><div class="flex justify-between items-center mb-3"><h4 class="text-sm font-bold text-indigo-800 uppercase tracking-wide flex items-center gap-2">‚ú® AI Trade Coach</h4><button id="btn-analyze-trade" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded shadow-sm transition-colors">Analyze This Trade</button></div><div id="ai-trade-analysis" class="text-xs text-indigo-900 leading-relaxed hidden ai-response"></div></div>
                    <div><h4 class="text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">Trade Details</h4><div class="bg-white border border-slate-200 rounded-lg overflow-hidden text-sm"><div class="p-3 bg-slate-50 border-b border-slate-100"><p class="text-xs font-semibold text-slate-500 uppercase mb-2">Biases & Confirmations</p><div class="flex gap-2 flex-wrap" id="modal-confirmations"></div></div><div class="grid grid-cols-2 border-b border-slate-100 p-3"><span class="text-slate-500">Side</span><span class="font-medium text-right" id="modal-side">--</span></div><div class="grid grid-cols-2 border-b border-slate-100 p-3"><span class="text-slate-500">Risk</span><span class="font-medium text-right" id="modal-risk">--%</span></div><div class="grid grid-cols-2 border-b border-slate-100 p-3"><span class="text-slate-500">Entry / Exit</span><span class="font-medium text-right" id="modal-prices">-- / --</span></div><div class="grid grid-cols-2 p-3"><span class="text-slate-500">Stop Loss</span><span class="font-medium text-right text-rose-500" id="modal-sl-pips">-- pips</span></div></div></div>
                    <div><h4 class="text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">Execution Notes</h4><div class="p-4 bg-yellow-50 border border-yellow-100 text-yellow-800 text-sm rounded-lg italic leading-relaxed" id="modal-notes">No notes added.</div></div>
                    <div><h4 class="text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">Chart Captures</h4><div id="modal-chart-container" class="min-h-[150px] space-y-4"></div></div>
                </div>
            </div>
        </div>

    </main>

    <script>
        const app = (() => {
            let auth, db, user;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
            let userApiKey = ""; // Stored locally
            
            const commonSymbols = ["XAUUSD", "BTCUSD", "ETHUSD", "SOLUSD", "XRPUSD", "ADAUSD", "SPX", "NDX", "DJI", "EURUSD", "GBPUSD", "USDJPY", "AAPL", "MSFT", "GOOGL", "AMZN", "NVDA", "TSLA", "META", "AMD", "NFLX", "SPY", "QQQ"];

            const state = {
                mockTrades: [],
                firestoreTrades: [],
                trades: [], 
                filterDate: 'all', 
                currentView: 'dashboard',
                charts: {},
                balance: 24500,
                currentTradeForAnalysis: null
            };

            // PASTE YOUR CONFIG HERE
const firebaseConfig = {
  apiKey: "AIzaSy...",
  authDomain: "trademaster-123.firebaseapp.com",
  projectId: "trademaster-123",
  storageBucket: "trademaster-123.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};

                    onAuthStateChanged(auth, (currentUser) => {
                        user = currentUser;
                        if (user) {
                            document.getElementById('login-screen').classList.add('hidden-fade');
                            if (user.isAnonymous) document.getElementById('user-name').innerText = "Guest User";
                            else document.getElementById('user-name').innerText = user.displayName || "User";
                            if (user.photoURL) document.getElementById('user-avatar').src = user.photoURL;
                            if (user.photoURL) document.getElementById('user-avatar').classList.remove('hidden');
                            
                            loadSettings();

                            const tradesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'trades');
                            const q = query(tradesRef, orderBy('createdAt', 'desc'));
                            onSnapshot(q, (snapshot) => {
                                state.firestoreTrades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date || new Date().toISOString().split('T')[0] }));
                                combineAndRender();
                            }, (error) => console.error("Firestore Error:", error));
                        } else {
                            document.getElementById('login-screen').classList.remove('hidden-fade');
                            state.firestoreTrades = []; combineAndRender();
                        }
                    });

                    document.getElementById('google-login-btn').onclick = async () => {
                        try {
                            const provider = new GoogleAuthProvider();
                            await signInWithPopup(auth, provider);
                        } catch (error) {
                            if (error.code === 'auth/unauthorized-domain' || error.code === 'auth/operation-not-allowed') {
                                try { await signInAnonymously(auth); } catch (e) {}
                            } else { alert("Login failed: " + error.message); }
                        }
                    };
                    document.getElementById('logout-btn').onclick = () => signOut(auth);
                }
            };

            // SETTINGS
            const openSettingsModal = () => { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('input-api-key').value = userApiKey; document.getElementById('check-enable-ai').checked = !!userApiKey; };
            const closeSettingsModal = () => document.getElementById('settings-modal').classList.add('hidden');
            const saveSettings = () => {
                const key = document.getElementById('input-api-key').value.trim();
                const enabled = document.getElementById('check-enable-ai').checked;
                if (enabled && !key) { alert("Please enter a valid API Key."); return; }
                userApiKey = enabled ? key : "";
                if (user) localStorage.setItem(`tm_ai_key_${user.uid}`, userApiKey);
                closeSettingsModal();
                alert("Settings saved!");
            };
            const loadSettings = () => { if (user) { const savedKey = localStorage.getItem(`tm_ai_key_${user.uid}`); if (savedKey) userApiKey = savedKey; } };

            // AI
            async function callGemini(prompt) {
                if (!userApiKey) { openSettingsModal(); return "<span>‚ö†Ô∏è Enable AI features in Settings to use this tool.</span>"; }
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    const data = await response.json();
                    if (data.error) return `<span class="text-red-600">API Error: ${data.error.message}</span>`;
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis available.";
                } catch (error) { return "Error generating analysis."; }
            }

            const analyzeTradeWithAI = async () => {
                const trade = state.currentTradeForAnalysis; if (!trade) return;
                const btn = document.getElementById('btn-analyze-trade'); const output = document.getElementById('ai-trade-analysis');
                btn.disabled = true; btn.innerText = "Analyzing..."; output.classList.remove('hidden'); output.innerHTML = `<div class="animate-pulse">Thinking...</div>`;
                const prompt = `Review trade: ${trade.symbol} (${trade.session}) | Side: ${trade.side} | P&L: ${trade.pnl} | Biases: Daily:${trade.confirmations?.daily}, H1:${trade.confirmations?.h1} | Risk: ${trade.riskPercent}% | Notes: ${trade.notes}`;
                const result = await callGemini(prompt);
                output.innerHTML = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                btn.innerText = "Re-Analyze"; btn.disabled = false;
            };

            const generateWeeklyInsight = async () => {
                if (!userApiKey) { openSettingsModal(); return; }
                const modal = document.getElementById('ai-insight-modal'); const content = document.getElementById('ai-insight-content');
                modal.classList.remove('hidden'); content.innerHTML = `<div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div><p class="text-slate-500 font-medium animate-pulse">Analyzing...</p>`;
                const recentTrades = state.trades.slice(0, 20).map(t => ({ symbol: t.symbol, session: t.session, pnl: t.pnl, rr: t.rr, setup: t.setup, result: t.status }));
                const result = await callGemini(`Analyze these 20 trades and return HTML report: ${JSON.stringify(recentTrades)}`);
                content.innerHTML = result.replace(/```html/g, '').replace(/```/g, '');
            };
            const closeAiInsightModal = () => document.getElementById('ai-insight-modal').classList.add('hidden');

            const searchSymbols = (val) => {
                const dropdown = document.getElementById('symbol-dropdown'); if (!val || val.length < 1) { dropdown.classList.add('hidden'); return; }
                const matches = commonSymbols.filter(s => s.toLowerCase().includes(val.toLowerCase())).slice(0, 10);
                if (matches.length > 0) { dropdown.innerHTML = ''; matches.forEach(symbol => { const div = document.createElement('div'); div.className = "px-4 py-2 hover:bg-slate-100 cursor-pointer text-sm font-semibold text-slate-700"; div.innerText = symbol; div.onclick = () => { document.getElementById('input-symbol').value = symbol; dropdown.classList.add('hidden'); calculateRR(); }; dropdown.appendChild(div); }); dropdown.classList.remove('hidden'); } else { dropdown.classList.add('hidden'); }
            };
            const hideSymbolDropdown = () => setTimeout(() => document.getElementById('symbol-dropdown').classList.add('hidden'), 200);
            const handleSymbolInput = (val) => { searchSymbols(val); calculateRR(); };

            const calculateRR = () => {
                const symbol = document.getElementById('input-symbol').value.toUpperCase(); const entry = parseFloat(document.getElementById('input-entry').value); const exit = parseFloat(document.getElementById('input-exit').value); const slPips = parseFloat(document.getElementById('input-sl-pips').value); const display = document.getElementById('rr-display');
                if (!symbol || isNaN(entry) || isNaN(exit) || isNaN(slPips) || slPips === 0) { display.innerText = "R:R --"; return; }
                let pipSize = 0.0001; if (symbol.includes('JPY')) pipSize = 0.01; if (symbol === 'XAUUSD') pipSize = 0.1; if (symbol === 'BTCUSD' || symbol === 'ETHUSD' || symbol.includes('SPX') || symbol.includes('NDX')) pipSize = 1.0;
                const rr = (Math.abs(exit - entry) / (slPips * pipSize)).toFixed(2);
                if(isFinite(rr) && rr > 0) { display.innerText = `R:R 1:${rr}`; display.className = `text-sm font-bold px-2 py-0.5 rounded ${rr >= 2 ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-700'}`; } else { display.innerText = "R:R --"; display.className = "text-sm font-bold text-slate-600 bg-slate-200 px-2 py-0.5 rounded"; }
            };

            // MOCK DATA
            const generateMockData = () => {
                const trades = []; const setups = ['HCS', 'IB Setup', 'HCS Negation', 'Negation']; const sides = ['Long', 'Short']; let balance = 20000; const startDate = new Date(); startDate.setDate(startDate.getDate() - 90);
                for (let i = 0; i < 85; i++) {
                    const date = new Date(startDate); date.setDate(date.getDate() + i + Math.floor(Math.random() * 2));
                    const isWin = Math.random() > 0.45; const symbol = commonSymbols[Math.floor(Math.random() * commonSymbols.length)];
                    const setup = setups[Math.floor(Math.random() * setups.length)]; const side = sides[Math.floor(Math.random() * sides.length)];
                    const basePrice = 100 + Math.random() * 200; const entry = parseFloat(basePrice.toFixed(2));
                    const move = isWin ? (Math.random() * 4 + 1) : -(Math.random() * 2 + 1); const exit = parseFloat((entry + (side === 'Long' ? move : -move)).toFixed(2));
                    const slPips = Math.floor(10 + Math.random() * 40);
                    let pipSize = 0.0001; if(symbol.includes('JPY')) pipSize=0.01; if(symbol==='XAUUSD') pipSize=0.1;
                    const rr = (Math.abs(exit-entry)/(slPips*pipSize)).toFixed(2);
                    const randBias = () => Math.random() > 0.5 ? 'Bullish' : (Math.random() > 0.2 ? 'Bearish' : 'Neutral');
                    const confirmations = { daily: randBias(), h11: randBias(), h7: randBias(), h3: randBias(), h1: randBias(), tsl: ['7 min', '10 min', '15 min'][Math.floor(Math.random()*3)], entryTf: ['1m', '2m', '3m', '4m', '5m'][Math.floor(Math.random()*5)] };
                    const netPnl = parseFloat((isWin ? (Math.random() * 500) : -(Math.random() * 200)).toFixed(2)); balance += netPnl;
                    trades.push({ id: `mock_${i}`, isMock: true, date: date.toISOString().split('T')[0], datetime: date, symbol, session: ['Asia', 'London', 'NY'][Math.floor(Math.random()*3)], side, setup, entry, exit, rr, slPips, riskPercent: (0.5+Math.random()).toFixed(1), confirmations, notes: isWin ? "Good follow through." : "Choppy.", pnl: netPnl, status: netPnl >= 0 ? 'WIN' : 'LOSS', screenshots: [] });
                }
                state.balance = balance; return trades.reverse();
            };

            const combineAndRender = () => {
                const allTrades = [...state.firestoreTrades, ...state.mockTrades];
                state.trades = allTrades.sort((a, b) => new Date(b.date) - new Date(a.date));
                let runningBalance = 20000; const chronoTrades = [...state.trades].sort((a, b) => new Date(a.date) - new Date(b.date));
                chronoTrades.forEach(t => { runningBalance += t.pnl; t.balanceAfter = parseFloat(runningBalance.toFixed(2)); });
                state.balance = runningBalance; updateKPIs(getFilteredTrades()); router(state.currentView);
            };

            const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
            const getFilteredTrades = () => { const now = new Date(); let days = state.filterDate === 'all' ? 9999 : parseInt(state.filterDate); const cutoff = new Date(); cutoff.setDate(now.getDate() - days); return state.trades.filter(t => new Date(t.date) >= cutoff); };

            // --- TRADE ACTIONS ---
            const openAddTradeModal = () => { 
                document.getElementById('add-trade-modal').classList.remove('hidden'); 
                document.getElementById('input-date').valueAsDate = new Date();
                document.getElementById('modal-title').innerText = "Log New Trade";
                document.getElementById('edit-trade-id').value = ""; // Clear ID
            };
            const closeAddTradeModal = () => { document.getElementById('add-trade-modal').classList.add('hidden'); document.getElementById('add-trade-form').reset(); document.getElementById('symbol-dropdown').classList.add('hidden'); document.getElementById('rr-display').innerText="R:R --"; };

            const editTrade = (trade) => {
                if(!trade) return;
                closeModal(); // Close detail view
                openAddTradeModal(); // Open form
                
                document.getElementById('modal-title').innerText = "Edit Trade";
                document.getElementById('edit-trade-id').value = trade.id; // SET ID
                
                document.getElementById('input-symbol').value = trade.symbol;
                document.getElementById('input-session').value = trade.session;
                document.getElementById('input-date').value = trade.date;
                document.getElementById('input-side').value = trade.side;
                document.getElementById('input-setup').value = trade.setup;
                
                // Confirmations
                if(trade.confirmations) {
                    document.getElementById('input-conf-daily').value = trade.confirmations.daily;
                    document.getElementById('input-conf-h11').value = trade.confirmations.h11;
                    document.getElementById('input-conf-h7').value = trade.confirmations.h7;
                    document.getElementById('input-conf-h3').value = trade.confirmations.h3;
                    document.getElementById('input-conf-h1').value = trade.confirmations.h1;
                    document.getElementById('input-conf-tsl').value = trade.confirmations.tsl;
                    document.getElementById('input-entry-tf').value = trade.confirmations.entryTf;
                }

                document.getElementById('input-entry').value = trade.entry;
                document.getElementById('input-exit').value = trade.exit;
                document.getElementById('input-sl-pips').value = trade.slPips;
                document.getElementById('input-risk-percent').value = trade.riskPercent;
                document.getElementById('input-notes').value = trade.notes || "";
                
                if(trade.screenshots && trade.screenshots.length > 0) {
                    document.getElementById('input-screenshot-urls').value = trade.screenshots.join('\n');
                }
                
                calculateRR(); // Update RR display
            };

            const saveTrade = async () => {
                if (!user) return;
                const { collection, addDoc, updateDoc, doc, serverTimestamp } = window.firebaseModules;

                const editId = document.getElementById('edit-trade-id').value; // CHECK ID
                
                const symbol = document.getElementById('input-symbol').value.toUpperCase();
                const session = document.getElementById('input-session').value;
                const dateVal = document.getElementById('input-date').value;
                const side = document.getElementById('input-side').value;
                const setup = document.getElementById('input-setup').value;
                const entry = parseFloat(document.getElementById('input-entry').value);
                const exit = parseFloat(document.getElementById('input-exit').value);
                const slPips = parseFloat(document.getElementById('input-sl-pips').value) || 0;
                const riskPercent = parseFloat(document.getElementById('input-risk-percent').value) || 0;
                const notes = document.getElementById('input-notes').value;
                const urlsValue = document.getElementById('input-screenshot-urls').value;
                const screenshotUrls = urlsValue.split('\n').map(u => u.trim()).filter(u => u.length > 0);

                const confirmations = {
                    daily: document.getElementById('input-conf-daily').value,
                    h11: document.getElementById('input-conf-h11').value,
                    h7: document.getElementById('input-conf-h7').value,
                    h3: document.getElementById('input-conf-h3').value,
                    h1: document.getElementById('input-conf-h1').value,
                    tsl: document.getElementById('input-conf-tsl').value,
                    entryTf: document.getElementById('input-entry-tf').value
                };

                let pipSize = 0.0001; if(symbol.includes('JPY')) pipSize=0.01; if(symbol==='XAUUSD') pipSize=0.1; if(symbol.includes('BTC')||symbol.includes('SPX')) pipSize=1.0;
                const riskDist = slPips * pipSize; const rewardDist = Math.abs(exit-entry);
                const rr = (riskDist > 0) ? (rewardDist/riskDist).toFixed(2) : "0.00";

                if(!symbol || !dateVal || isNaN(entry) || isNaN(exit)) return;

                const dummySize = 100; 
                let pnl = side === 'Long' ? (exit - entry) * dummySize : (entry - exit) * dummySize;
                pnl = parseFloat(pnl.toFixed(2));

                const tradeData = {
                    date: dateVal, symbol, session, side, setup, entry, exit,
                    slPips, riskPercent, rr, confirmations, notes,
                    pnl, status: pnl >= 0 ? 'WIN' : 'LOSS',
                    screenshots: screenshotUrls, createdAt: serverTimestamp()
                };

                try {
                    if (editId) {
                        // UPDATE EXISTING
                        if (editId.startsWith('mock_')) {
                            const idx = state.mockTrades.findIndex(t => t.id === editId);
                            if (idx !== -1) {
                                state.mockTrades[idx] = { ...state.mockTrades[idx], ...tradeData, id: editId }; // Merge
                                combineAndRender();
                            }
                        } else {
                            // Update Cloud
                            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'trades', editId), tradeData);
                        }
                    } else {
                        // CREATE NEW
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'trades'), tradeData);
                    }
                    closeAddTradeModal();
                } catch (e) { console.error("Error saving trade", e); alert("Could not save trade."); }
            };

            const updateKPIs = (trades) => {
                const totalPnl = trades.reduce((acc, t) => acc + t.pnl, 0); const winTrades = trades.filter(t => t.pnl > 0); const lossTrades = trades.filter(t => t.pnl <= 0);
                const winRate = trades.length ? ((winTrades.length / trades.length) * 100).toFixed(1) : 0;
                const grossProfit = winTrades.reduce((acc, t) => acc + t.pnl, 0); const grossLoss = Math.abs(lossTrades.reduce((acc, t) => acc + t.pnl, 0));
                const pf = grossLoss === 0 ? grossProfit.toFixed(2) : (grossProfit / grossLoss).toFixed(2);
                document.getElementById('kpi-pnl').innerText = formatCurrency(totalPnl);
                document.getElementById('kpi-pnl').className = `text-2xl font-bold mt-1 ${totalPnl >= 0 ? 'text-emerald-600' : 'text-rose-600'}`;
                document.getElementById('kpi-winrate').innerText = `${winRate}%`; document.getElementById('kpi-pf').innerText = pf; document.getElementById('account-balance').innerText = formatCurrency(state.balance);
            };

            const renderDashboard = () => {
                const trades = getFilteredTrades(); const chronoTrades = [...trades].sort((a,b) => new Date(a.date) - new Date(b.date));
                const ctxEquity = document.getElementById('chart-equity').getContext('2d'); if (state.charts.equity) state.charts.equity.destroy();
                state.charts.equity = new Chart(ctxEquity, { type: 'line', data: { labels: chronoTrades.map(t => t.date), datasets: [{ label: 'Account Balance', data: chronoTrades.map(t => t.balanceAfter), borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } } });
                const ctxWinLoss = document.getElementById('chart-winloss').getContext('2d'); if (state.charts.winLoss) state.charts.winLoss.destroy();
                state.charts.winLoss = new Chart(ctxWinLoss, { type: 'doughnut', data: { labels: ['Wins', 'Losses'], datasets: [{ data: [trades.filter(t => t.pnl > 0).length, trades.filter(t => t.pnl <= 0).length], backgroundColor: ['#10b981', '#f43f5e'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
            };

            const renderJournal = () => {
                const trades = getFilteredTrades(); const tbody = document.getElementById('journal-table-body'); tbody.innerHTML = '';
                trades.forEach(t => {
                    const row = document.createElement('tr'); row.className = 'hover:bg-slate-50 cursor-pointer transition-colors border-b border-slate-50';
                    row.onclick = () => openModal(t); const pnlClass = t.pnl >= 0 ? 'text-emerald-600' : 'text-rose-600'; const bgClass = t.pnl >= 0 ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'; const sourceIcon = t.isMock ? '' : '<span class="mr-1 text-xs">‚òÅÔ∏è</span>';
                    row.innerHTML = `<td class="px-6 py-4 font-medium text-slate-700 flex items-center gap-1">${sourceIcon} ${t.date}</td><td class="px-6 py-4 font-bold">${t.symbol}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-semibold ${t.side === 'Long' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}">${t.side}</span></td><td class="px-6 py-4 text-center font-mono text-xs bg-slate-100 rounded">${t.rr || '-'}</td><td class="px-6 py-4 text-right">${t.riskPercent || '-'}%</td><td class="px-6 py-4 text-right">$${t.entry}</td><td class="px-6 py-4 text-right">$${t.exit}</td><td class="px-6 py-4 text-right font-bold ${pnlClass}">${t.pnl > 0 ? '+' : ''}${formatCurrency(t.pnl)}</td><td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded text-xs font-bold ${bgClass}">${t.status}</span></td>`;
                    tbody.appendChild(row);
                });
            };

            const renderAnalytics = () => {
                const trades = getFilteredTrades(); const aggregate = (key) => { const result = {}; trades.forEach(t => { let k = t[key]; if (key === 'dow') k = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][new Date(t.date).getDay()]; if (key === 'hour') k = "10:00"; if (!result[k]) result[k] = 0; result[k] += t.pnl; }); return result; };
                const setupData = aggregate('setup'); if (state.charts.setup) state.charts.setup.destroy();
                state.charts.setup = new Chart(document.getElementById('chart-setup').getContext('2d'), { type: 'bar', data: { labels: Object.keys(setupData), datasets: [{ label: 'Net P&L', data: Object.values(setupData), backgroundColor: Object.values(setupData).map(v => v >= 0 ? '#10b981' : '#f43f5e'), borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                const dowData = aggregate('dow'); if (state.charts.dow) state.charts.dow.destroy();
                state.charts.dow = new Chart(document.getElementById('chart-dow').getContext('2d'), { type: 'bar', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'], datasets: [{ label: 'P&L', data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(d => dowData[d] || 0), backgroundColor: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(d => (dowData[d]||0) >= 0 ? '#10b981' : '#f43f5e'), borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                const dirData = aggregate('side'); if (state.charts.dir) state.charts.dir.destroy();
                state.charts.dir = new Chart(document.getElementById('chart-direction').getContext('2d'), { type: 'pie', data: { labels: Object.keys(dirData), datasets: [{ data: Object.values(dirData), backgroundColor: ['#60a5fa', '#fb923c'] }] }, options: { responsive: true, maintainAspectRatio: false } });
                const ctxHour = document.getElementById('chart-hour').getContext('2d'); if (state.charts.hour) state.charts.hour.destroy();
                state.charts.hour = new Chart(ctxHour, { type: 'line', data: { labels: ['9:30', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00'], datasets: [{ label: 'No Time Data', data: [0,0,0,0,0,0,0], borderColor: '#cbd5e1' }] }, options: { responsive: true, maintainAspectRatio: false } });
            };

            const renderCalendar = () => {
                const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
                const today = new Date(); const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate(); const startDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
                for (let i = 0; i < startDay; i++) grid.appendChild(document.createElement('div'));
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayTrades = state.trades.filter(t => t.date === dateStr); const dayPnl = dayTrades.reduce((acc, t) => acc + t.pnl, 0);
                    const cell = document.createElement('div'); cell.className = `h-24 border border-slate-100 rounded p-2 flex flex-col justify-between relative hover:shadow-md transition-shadow bg-white ${dayTrades.length ? (dayPnl > 0 ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100') : ''}`;
                    cell.innerHTML = `<span class="text-xs font-semibold text-slate-500">${day}</span>${dayTrades.length > 0 ? `<span class="${dayPnl > 0 ? 'text-emerald-600' : 'text-rose-600'} text-sm font-bold self-center">${formatCurrency(dayPnl)}</span>` : ''}${dayTrades.length > 0 ? `<span class="text-[10px] text-slate-400 text-center">${dayTrades.length} Trades</span>` : ''}`;
                    grid.appendChild(cell);
                }
            };

            const renderPlaybook = () => {
                const container = document.getElementById('playbook-container'); container.innerHTML = '';
                const setups = {}; state.trades.forEach(t => { if (!setups[t.setup]) setups[t.setup] = { count: 0, wins: 0, pnl: 0, bestWin: 0 }; setups[t.setup].count++; setups[t.setup].pnl += t.pnl; if (t.pnl > 0) { setups[t.setup].wins++; if (t.pnl > setups[t.setup].bestWin) setups[t.setup].bestWin = t.pnl; } });
                Object.keys(setups).forEach(setupName => {
                    const s = setups[setupName]; const winRate = ((s.wins / s.count) * 100).toFixed(0); const pnlClass = s.pnl >= 0 ? 'text-emerald-600' : 'text-rose-600';
                    const card = document.createElement('div'); card.className = 'bg-white rounded-xl border border-slate-200 p-6 shadow-sm hover:border-indigo-300 transition-colors';
                    card.innerHTML = `<div class="flex justify-between items-start mb-4"><h4 class="font-bold text-lg text-slate-800">${setupName}</h4><span class="px-2 py-1 bg-indigo-50 text-indigo-700 text-xs font-bold rounded uppercase">Active</span></div><div class="grid grid-cols-2 gap-4 mb-4"><div><p class="text-xs text-slate-400 uppercase">Total P&L</p><p class="text-lg font-bold ${pnlClass}">${formatCurrency(s.pnl)}</p></div><div><p class="text-xs text-slate-400 uppercase">Win Rate</p><p class="text-lg font-bold text-slate-700">${winRate}%</p></div><div><p class="text-xs text-slate-400 uppercase">Trades</p><p class="text-base font-semibold text-slate-700">${s.count}</p></div><div><p class="text-xs text-slate-400 uppercase">Best Win</p><p class="text-base font-semibold text-emerald-600">+${formatCurrency(s.bestWin)}</p></div></div><div class="w-full bg-slate-100 rounded-full h-2 mb-2"><div class="bg-indigo-500 h-2 rounded-full" style="width: ${winRate}%"></div></div>`;
                    container.appendChild(card);
                });
            };

            const openModal = (trade) => {
                state.currentTradeForAnalysis = trade;
                const modal = document.getElementById('trade-modal'); const content = document.getElementById('trade-modal-content');
                document.getElementById('modal-symbol').innerText = trade.symbol; document.getElementById('modal-session-date').innerText = `${trade.session || 'N/A'} ‚Ä¢ ${new Date(trade.date).toLocaleDateString()}`;
                document.getElementById('modal-pnl').innerText = (trade.pnl > 0 ? '+' : '') + formatCurrency(trade.pnl); document.getElementById('modal-pnl').className = `text-xl font-bold mt-1 ${trade.pnl >= 0 ? 'text-emerald-600' : 'text-rose-600'}`;
                document.getElementById('modal-setup').innerText = trade.setup; document.getElementById('modal-side').innerText = trade.side; document.getElementById('modal-side').className = `text-lg font-medium mt-1 ${trade.side === 'Long' ? 'text-blue-600' : 'text-orange-600'}`;
                document.getElementById('modal-risk').innerText = (trade.riskPercent || '-') + '% / R:R ' + (trade.rr || '-'); document.getElementById('modal-sl-pips').innerText = (trade.slPips || '-') + ' pips'; document.getElementById('modal-prices').innerText = `${trade.entry} / ${trade.exit}`; document.getElementById('modal-notes').innerText = trade.notes || 'No notes added.';
                
                const confContainer = document.getElementById('modal-confirmations'); confContainer.innerHTML = '';
                const confs = trade.confirmations || {};
                const createBadge = (label, val) => {
                    let color = 'bg-slate-100 text-slate-500';
                    if (val === 'Bullish') color = 'bg-emerald-100 text-emerald-700'; else if (val === 'Bearish') color = 'bg-rose-100 text-rose-700'; else if (val === 'Yes' || val === '7 min' || val === '10 min' || val === '15 min') color = 'bg-indigo-100 text-indigo-700'; else if (val === 'Neutral' || val === 'None') color = 'bg-gray-100 text-gray-600';
                    const badge = document.createElement('span'); badge.className = `px-2 py-1 rounded text-xs font-bold uppercase ${color} border border-transparent`; badge.innerText = `${label}: ${val}`; confContainer.appendChild(badge);
                };
                createBadge('Daily', confs.daily || '-'); createBadge('H11', confs.h11 || '-'); createBadge('H7', confs.h7 || '-'); createBadge('H3', confs.h3 || '-'); createBadge('H1', confs.h1 || '-'); createBadge('TSL', confs.tsl || '-'); createBadge('TF', confs.entryTf || '-');

                document.getElementById('ai-trade-analysis').classList.add('hidden'); document.getElementById('ai-trade-analysis').innerHTML = ''; document.getElementById('btn-analyze-trade').innerText = "Analyze This Trade"; document.getElementById('btn-analyze-trade').onclick = analyzeTradeWithAI;
                const imgContainer = document.getElementById('modal-chart-container'); imgContainer.innerHTML = '';
                const shots = (trade.screenshots && trade.screenshots.length > 0) ? trade.screenshots : (trade.screenshot ? [trade.screenshot] : []);
                if (shots.length > 0) { imgContainer.className = "grid grid-cols-1 gap-4"; shots.forEach(url => { imgContainer.innerHTML += `<img src="${url}" class="w-full h-auto rounded-lg border border-slate-200 hover:opacity-95 transition-opacity" alt="Trade Screenshot">`; }); } else { imgContainer.className = "bg-slate-100 rounded-lg border border-slate-200 flex items-center justify-center text-slate-400 text-sm overflow-hidden min-h-[150px]"; imgContainer.innerHTML = `<span class="italic text-slate-400">No screenshot linked</span>`; }
                modal.classList.remove('hidden'); setTimeout(() => content.classList.remove('translate-x-full'), 10);
            };

            const closeModal = () => { const modal = document.getElementById('trade-modal'); const content = document.getElementById('trade-modal-content'); content.classList.add('translate-x-full'); setTimeout(() => modal.classList.add('hidden'), 300); };

            const router = (targetId) => {
                state.currentView = targetId; document.querySelectorAll('.nav-item').forEach(el => { if (el.dataset.target === targetId) el.classList.add('bg-slate-50', 'text-indigo-600'); else el.classList.remove('bg-slate-50', 'text-indigo-600'); });
                const titles = { 'dashboard': 'Dashboard Overview', 'journal': 'Trade Journal', 'analytics': 'Advanced Reports', 'calendar': 'P&L Calendar', 'playbook': 'Strategy Playbook' };
                document.getElementById('page-title').innerText = titles[targetId];
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${targetId}`).classList.remove('hidden');
                if (targetId === 'dashboard') renderDashboard(); if (targetId === 'journal') renderJournal(); if (targetId === 'analytics') renderAnalytics(); if (targetId === 'calendar') renderCalendar(); if (targetId === 'playbook') renderPlaybook();
                if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
            };

            const updateGlobalFilter = (val) => { state.filterDate = val; router(state.currentView); };
            const init = () => { state.mockTrades = generateMockData(); initFirebase(); document.getElementById('mobile-menu-btn').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full')); document.getElementById('close-menu-btn').addEventListener('click', () => document.getElementById('sidebar').classList.add('-translate-x-full')); };

            // Helper to get current trade from modal scope safely
            const getCurrentTrade = () => state.currentTradeForAnalysis;

            return { router, updateGlobalFilter, closeModal, openAddTradeModal, closeAddTradeModal, saveTrade, searchSymbols, hideSymbolDropdown, generateWeeklyInsight, closeAiInsightModal, handleSymbolInput, calculateRR, openSettingsModal, closeSettingsModal, saveSettings, editTrade: (t) => {
                // Expose editTrade function
                // Close Detail, Open Edit with pre-filled data
                // This logic was embedded in previous response, ensuring it's accessible here
                
                if(!t) return;
                closeModal();
                openAddTradeModal();
                document.getElementById('modal-title').innerText = "Edit Trade";
                document.getElementById('edit-trade-id').value = t.id;
                
                document.getElementById('input-symbol').value = t.symbol;
                document.getElementById('input-session').value = t.session;
                document.getElementById('input-date').value = t.date;
                document.getElementById('input-side').value = t.side;
                document.getElementById('input-setup').value = t.setup;
                
                if(t.confirmations) {
                    document.getElementById('input-conf-daily').value = t.confirmations.daily;
                    document.getElementById('input-conf-h11').value = t.confirmations.h11;
                    document.getElementById('input-conf-h7').value = t.confirmations.h7;
                    document.getElementById('input-conf-h3').value = t.confirmations.h3;
                    document.getElementById('input-conf-h1').value = t.confirmations.h1;
                    document.getElementById('input-conf-tsl').value = t.confirmations.tsl;
                    document.getElementById('input-entry-tf').value = t.confirmations.entryTf;
                }

                document.getElementById('input-entry').value = t.entry;
                document.getElementById('input-exit').value = t.exit;
                document.getElementById('input-sl-pips').value = t.slPips;
                document.getElementById('input-risk-percent').value = t.riskPercent;
                document.getElementById('input-notes').value = t.notes || "";
                if(t.screenshots) document.getElementById('input-screenshot-urls').value = t.screenshots.join('\n');
                
                calculateRR();
            }, getCurrentTrade, init };
        })();

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>